#!/bin/env sh

### --HELP START-- ###

# Automate youtube-dl downloads

# The URL you are trying to download should be in your clipboard.

# The way it works:

# Options:
# -a: Download only audio
# -h: This help message

# dakodeon, 2020

# TODO list:
# * Add functionality to also give url(s) as positional parameters

### --HELP END-- ###

# for dunstify
did=123987

dl_dir=$HOME/Downloads/youtube-downloads

link="$(xclip -selection clipboard -o)"

# defaults to video
media="video"

# exit if no valid link
! expr "$link" : '^http' >/dev/null && dunstify -r $did " Download stuff" "No valdid link in clipboard" && exit 23

while getopts ":ah" opt; do
    case $opt in
	a)
	    audopt="-x --audio-format mp3"
	    media="audio"
	    ;;
	h) 
	    sed '0,/HELP START/d;/HELP END/,$d;s/^# //' "$0"
	    exit
	    ;;
	\?)
	    echo "Unknown option. Run with -h for help." >&2
	    ;;
	:)
	    echo "Missing argument for option -$OPTARG." >&2
	    ;;
    esac
done

shift $((OPTIND-1))

dunstify -r $did " Please wait" "Preparing for $media download "

title="$(youtube-dl -e "$link")"

dunstify -r $did " Downloading $media" "\"$title\""

youtube-dl $audopt -q -i -c -o "$dl_dir/%(title)s.%(ext)s" "$link" && \
    dunstify -r $did " Download complete" "\"$title\"" || \
	dunstify -r $did "  Download failed:" "\"$title\""
